---
html_document: null
author: "Andhy Gomez, Kelly Rivera"
title: "NBA Statistical Analysis"
df_print: paged
---

The NBA implemented the now integral three-point line in the 1979-1980 season, in its early years it was never seen as a very important part of the game however over the years players like Reggie Miller, Ray Allen, and Stephen Curry have revolutionized the game of basketball to the point where 3-point shooting is so crucial towards winning that even Centers have now learned to shoot from 3. In this project we will analyze the increase in popularity and how important they are to win.

# R Programming {.tabset .tabset-fade .tabset-pills}
## Packages and Libraries
### Install libraries
```{r}
#install.packages("tidyverse")
#install.packages("knitr")
#install.packages("rmarkdown")
#install.packages("forecast")
#install.packages("party")
#install.packages("TSA")
#install.packages("party")
#install.packages("caTools")
```

### Load libraries
```{r}
library(tidyverse)
library(knitr)
library(forecast)
library(reshape2)
library(caTools)
library(party)
library(rmarkdown)
```

## General Prep
Firstly we will be looking at data throughout the regular season since the three point line was implemented.
### Create data frames
```{r}
# General Data
seasonStats <- read.csv("Data/Seasons_Stats.csv")
```

### View the data
```{r}
head(seasonStats)
```

### Subset the data
```{r}
# Fetch only the years from when the 3-point line was implemented
post3pl <- subset(seasonStats, Year >= 1980)
head(post3pl)
# Select only columns that will be used for analysis
newPost3pl <- select(post3pl, Year, Player, Tm, X2PA, X3PAr, X3P, X3PA, X3P., PTS)
head(newPost3pl)
```

### Convert Year to Factors
Year should be factors, not ints
```{r}
#newPost3pl$Year <- as.factor(newPost3pl$Year)
head(newPost3pl)
```

### Group data by year
```{r}
by_year <- group_by(newPost3pl, Year)
avg3pa <- summarise(by_year, Average3PA = mean(X3PA), Average2PA = mean(X2PA))
head(avg3pa)
```

### Visualize the data
```{r}
ggplot(data = avg3pa, mapping = aes(x = Year, y = Average3PA, fill = as.factor(Year))) +
        geom_col(show.legend = FALSE) +
        theme(axis.text.x = element_text(angle =- 90, vjust = 0.5)) +
        labs(title = "Average 3pt FGA per Player per Year" ,
         subtitle = "NBA: 1980-2017" ,
         caption = "Source: Kaggle",
         x = "Year", y = "Average 3P FGA")
```

```{r}
# Average 3pt fga in 1980
avg3pa1980 <- avg3pa$Average3PA[1]
avg3pa2017 <- avg3pa$Average3PA[38]
```

The bar graph clearly shows a meteoric rise in popularity of the 3 point shot. In the year it was first implemented the average player would take `r avg3pa1980` three-point shots in a whole season whereas in the 2017 season the average player takes `r avg3pa2017` in a season. Nearly 8 times as much as in 1980. 

```{r}
ggplot() + 
  geom_smooth(data = avg3pa, aes(x = Year, y = Average2PA), color = "blue",
              method = loess) +
  geom_smooth(data = avg3pa, aes(x = Year, y = Average3PA), color = "red",
              method = loess) +
  theme(axis.text.x = element_text(angle =- 90, vjust = 0.5)) +
  labs(title = "Average 2pt FGA vs Average 3pt FGA" ,
         subtitle = "NBA: 1980-2017" ,
         caption = "Source: Kaggle",
         x = "Year", y = "Average FGA")
```

The scatter plot shows the steady decrease in popularity of the two-point shot as the three-point shot rises in popularity.


## Time Series
### Import Data
```{r}
teams <- read.csv("Data/basketball_teams.csv")
```

### Subset Data to be post 1980 and NBA teams only
```{r}
nba80sTo05 <- subset(teams, lgID == "NBA" & year >= 1980 & year <= 2005)
head(nba80sTo05)
nba06To11 <- subset(teams, lgID == "NBA" & year >= 2006)
head(nba06To11)
nbaNow <- subset(teams, lgID == "NBA" & year >= 1980)
head(nbaNow)
```

##Time Series analysis of 3PA
### Model
```{r}
teamModel <- auto.arima(train3paSeries)
teamForecast <-forecast(teamModel, h = 12)
teamForecast
```

### Create Training and Testing Sets
```{r}
# training set: 
avg3pa$Year <- as.integer(avg3pa$Year)
train3pa <- subset(avg3pa, Year >= 1980 & Year <= 2005)
train3paSeries = ts(train3pa[, 2], frequency = 1)
# test set:   
test3pa <- subset(avg3pa, Year > 2004)
test3paSeries = ts(test3pa[, 2], frequency = 1)
```

### Model
```{r}
teamModel <- auto.arima(train3paSeries)
teamForecast <-forecast(teamModel)
head(teamForecast)
```

### Visualizations
### History and Predictions
```{r}
plot(teamForecast, main = "Average Predicted 3 pt Attempts", ylab = "Predicted Attempts", xlab = "Season")
lines(x = 26:38, y = test3paSeries, col="red")
legend("topleft", lty = 1, bty = "n", col = c("red","blue"), c("Actual","Predicted"))
```




## Linear Regression
### Correlation: Pairs Plot
Pair plot to see correlation between variables
```{r}
rank3pm <- select(nba80sTo05, c("rank", "lost"))
pairs(rank3pm)
```

### Corrlation: calculation
Calculate correlation value [-1, 1]
```{r}
rankLostCorr <- cor(nba06To11$rank, nba06To11$lost)
rankLostCorr
```
Rank and Games Lost correlation: `r rankLostCorr`.

### Univariate Linear Regression
Given 1 independent variable, predict the dependent variable.
Given games lost, let's predict the team's rank.
```{r}
rankLostModel <- lm(rank ~ lost, data = nba06To11)
rankLostModel
```

### Prediction
Given a loss count of 28, predict the rank.
```{r}
# Create a data frame with a single 3pa entry
testSet1 <- data.frame(lost = c(28))
# Predict the position with the model and test data
predictedRank <- predict(rankLostModel, testSet1)
predictedRank
```
At 28 games lost, the rank should be approximately, `r predictedRank`.

### Verification
Let's see the average rank at 28 loss count
```{r}
# Output table with loss of 28
lost28 <- subset(nba06To11, lost == 28)
lost28
# Calculate the average and sd of rank when 3pa is 1500
avgRank <- mean(lost28$rank)
avgRank
sdRank <- sd(lost28$rank)
sdRank
```
At 28 losses the average rank is actually `r avgRank` with a standard deviation of `r sdRank`.

### Games Lost vs. Rank
```{r}
ggplot(data = nba06To11, mapping = aes(x = lost, y = rank)) +
  geom_point(mapping = aes(color = tmID)) +
  geom_smooth(method = "lm") +
  labs(title = "Games Lost vs Rank" ,
         subtitle = "NBA: 2006-2011" ,
         x = "Games Lost")
```

### Accuracy
```{r}

```


## Hypothesis Testing

```{r}
# Nba Finals 
champs <- read.csv("Data/championsdata.csv")
runnerUps <- read.csv("Data/runnerupsdata.csv")
nbaFinals <- rbind(champs, runnerUps)
head(nbaFinals)
```

```{r}
# Organize the data by year
finalsSorted <- arrange(nbaFinals, Year)
head(finalsSorted)
```

### Convert categorical data to Factors
```{r}
finalsSorted$Year <- as.factor(finalsSorted$Year)
finalsSorted$Win <- as.factor(finalsSorted$Win)
finalsSorted$Game <- as.factor(finalsSorted$Game)
finalsSorted$Home <- as.factor(finalsSorted$Home)
head(finalsSorted)
```

### The Welch Two Sample T-Test (Unpaired) to determine if Early TPL adoption vs Modern NBA use of the Three Point line.
```{r}
#p-value < alpha (0.05)
#H0 The two samples are not significantly different. 
#HA The two samples are signficantly different.
avgEarlytpl <- mean(nba80sTo05$o_3pa)
avgModerntpl <- mean(nba06To11$o_3pa)
cat("Average Three Point Attempts between 1980-2005:", avgEarlytpl, "\n" ) 
cat("Average Three Point Attempts between 2006-2011:", avgModerntpl, "\n") 
```

```{r}
# Perform T-Test (Unpaired)
t.test(nba80sTo05$o_3pa, nba06To11$o_3pa, paired = FALSE)
```

```{r}
cat("p-value < alpha (0.05). The samples are signifcantly different, H0 rejected.\n")
cat("The Early  three point attempts and Modern NBA three point attempts are significantly different.\n")
```

### The Welch Two Sample T-Test (Unpaired) to determine if Early NBA & Modern NBA use of defensive steals are significantly different.
```{r}
avgEarlystl <- mean(nba80sTo05$d_stl)
avgModerndstl <- mean(nba06To11$d_stl)
cat("Average Defensive Steals between seasons 1980-2005:", avgEarlystl, "\n" ) 
cat("Average Defensive Steals between seasons 2006-2011:", avgModerndstl, "\n") 
```

```{r}
# Perform T-Test (Unpaired)
t.test(nba80sTo05$d_stl, nba06To11$d_stl, paired = FALSE)
```

```{r}
cat("p-value < alpha (0.05). The samples are signifcantly different, H0 rejected.\n")
cat("The Early  three point attempts and Modern NBA three point attempts are significantly different.\n")
```

## Classification using Decision Trees
### Build the Tree
Given a Team's points, assists, and steals, in the NBA Finals did they Win or Lose?
```{r}
tree <- ctree(Win ~ PTS + AST + STL, data = finalsSorted)
tree
```

### Visualize the tree
```{r}
plot(tree)
```

### Prediction
If the give Team earns 112 points, 20 assists, and 10 steals, did the Team win or lose in the final?
```{r}
testgame <- data.frame(PTS = as.integer(c(112)),
                          AST = as.integer(c(20)),
                          STL = as.integer(c(10)))
predictedOutcome <- predict(tree, newdata = testgame)
ifelse(predictedOutcome == 1, "Win", "Lose")
predictedOutcome
```

## Clustering
```{r}
# Set the random seed
set.seed(20)
# Extract only team division and width data for clustering
threept <- data.frame(Attempted = nbaNow$o_3pa, Made = nbaNow$o_3pm)
head(threept)
```

K Means Algorithm
        k = number of clusters
        nstart = number of runs with different intial centroids
        
```{r}
# Preform kmeans with k set to 3
threeCluster <- kmeans(threept, 3, nstart = 25)
threeCluster
```

Kmeans Verification and visualization

### Verify
```{r}
table(threeCluster$cluster, nbaNow$divID)
```

### Visualize Cluster
```{r}
# Add the cluster assignment to each point 
nbaNow$Cluster <- as.factor(threeCluster$cluster)
# Get centroids
centroids <- as.data.frame(threeCluster$centers)
centroids$Cluster <- as.factor(c(1:3))
# Vizualize cluster assignments
ggplot(data = nbaNow, mapping = aes(o_3pa, o_3pm, color = Cluster)) + 
  geom_point() +
  geom_point(data = centroids, aes(x = Attempted, y = Made, fill = Cluster), size = 5, color = "black", shape = 13) +
  labs(title = "3 Pointers Attempted vs 3 Pointers Made", x = "3pt Attemped", y = "3pt Made")
```

### Within sum of squatre (WSS)
```{r}
# For each k, perform WSS, store the value
wss<- numeric(15)
for (k in 1:15)
  wss[k] = sum(kmeans(threept, k, nstart = 25)$withinss)
```

```{r}
# Make a data frame out of the WSS results
wssResults <- data.frame(k = c(1:15), wss = wss)
wssResults
```

```{r}
# Vizualize WSS
ggplot(data = wssResults, mapping = aes(x= k, y= wss)) +
  geom_point() +
  geom_line() +
  labs(title = "K-means", x = "Number of Clusters k", y = "Within Sum of Squares")
```

